<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback Intelligence Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #f7f9fc 0%, #ffffff 100%);
      color: #1d2125;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .header {
      background: #2d2d2d;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 {
      color: #ffffff;
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
      letter-spacing: -0.01em;
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .analysis-status {
      background: rgba(16, 185, 129, 0.1);
      padding: 0.375rem 0.875rem;
      border-radius: 4px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: #059669;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .container {
      max-width: 1400px;
      margin: 1.5rem auto;
      padding: 0 2rem;
    }
    .ai-search-container {
      background: white;
      border-radius: 8px;
      padding: 1.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      border: 1px solid #e1e4e8;
    }
    .ai-search-header h2 {
      color: #1d2125;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-align: left;
    }
    .feedback-table {
      background: white;
      border-radius: 8px;
      padding: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      overflow: hidden;
      border: 1px solid #e1e4e8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #fafbfc;
      border-bottom: 1px solid #e1e4e8;
    }
    th {
      text-align: left;
      padding: 1rem;
      color: #626f86;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    td {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.875rem;
      color: #1d2125;
    }
    tbody tr {
      transition: background 0.15s ease;
    }
    tbody tr:hover {
      background: #f8f9fa;
      cursor: pointer;
    }
    .filter-controls {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-select {
      padding: 0.5rem 0.875rem;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      font-size: 0.875rem;
      background: white;
      color: #1d2125;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-select:hover {
      border-color: #c1c7cd;
    }
    .filter-select:focus {
      outline: none;
      border-color: #5e6ad2;
      box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1);
    }
    .badge {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      border-radius: 3px;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: capitalize;
    }
    .badge-low { background: #d3f5e8; color: #00875a; }
    .badge-medium { background: #fff4e6; color: #ff8b00; }
    .badge-high { background: #ffebe6; color: #de350b; }
    .badge-on-track { background: #deebff; color: #0052cc; }
    .badge-at-risk { background: #fff4e6; color: #ff8b00; }
    .badge-off-track { background: #ffebe6; color: #de350b; }
  </style>
  <link rel="stylesheet" href="styles.css?v=3.0">
  <link rel="stylesheet" href="toast.css?v=3.0">
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>Feedback Dashboard</h1>
      <div class="header-actions">
        <div class="analysis-status" id="analysisStatus">
          <span id="statusText">Live</span>
          <span class="status-badge" id="statusBadge" style="display: none;"></span>
        </div>
      </div>
    </div>
  </div>


  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-label">Total Feedback</div>
      <div class="metric-value" id="totalFeedback">0</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Top Themes</div>
      <div id="topThemesDisplay" style="font-size: 0.875rem; color: #667eea; font-weight: 600;">-</div>
    </div>
  </div>

  <div class="dashboard-container">
    <main class="main-content" style="padding-left: 0;">
      <!-- AI-Powered Search Section -->
      <div class="ai-search-container">
        <div class="ai-search-header">
          <h2>Search Feedback</h2>
          <p class="ai-search-subtitle">AI-Powered Semantic Search</p>
        </div>
        <div class="ai-search-box">
          <input 
            type="text" 
            class="ai-search-input" 
            id="aiSearchInput" 
            placeholder="Search for similar feedback by topic or issue"
          >
          <button class="btn btn-search" id="aiSearchBtn">Search</button>
        </div>
        <p class="ai-search-explanation">
          Uses AI to find related feedback based on meaning, not just keywords
        </p>
      </div>

      <!-- Search Results Container -->
      <div class="search-results-container" id="searchResultsContainer" style="display: none;">
        <div class="search-results-header">
          <h3 id="searchResultsTitle">Search Results</h3>
          <button class="btn btn-clear" id="clearSearchBtn">Clear Search</button>
        </div>
        <div id="searchResultsContent"></div>
      </div>

      <div class="card">
        <h3>Feedback Items</h3>
        <div class="filters">
          <input type="text" class="search-input" id="searchInput" placeholder="Search feedback...">
          <select class="filter-select" id="sourceFilter">
            <option value="">All Sources</option>
            <option value="support_ticket">Support Ticket</option>
            <option value="discord">Discord</option>
            <option value="github">GitHub</option>
            <option value="twitter">Twitter</option>
            <option value="email">Email</option>
          </select>
          <select class="filter-select" id="sentimentFilter">
            <option value="">All Sentiments</option>
            <option value="positive">Positive</option>
            <option value="neutral">Neutral</option>
            <option value="negative">Negative</option>
          </select>
          <select class="filter-select" id="urgencyFilter">
            <option value="">All Urgency</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>

        <div class="spinner" id="loadingSpinner"></div>
        <div class="error-message" id="errorMessage"></div>

        <table class="feedback-table" id="feedbackTable">
          <thead>
            <tr>
              <th>Source</th>
              <th>Content</th>
              <th>Sentiment</th>
              <th>Urgency</th>
              <th>Themes</th>
              <th>Attachment</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="feedbackTableBody">
          </tbody>
        </table>
        <div class="table-hint">Click any row to view details</div>
      </div>
    </main>
  </div>

  <div class="modal" id="feedbackModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Feedback Details</h2>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
      </div>
    </div>
  </div>

  <button class="fab" id="addFeedbackFab" title="Add New Feedback">
    ‚ûï
  </button>

  <div class="modal" id="aiSummaryModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>‚ú® AI-Powered Feedback Summary</h2>
        <button class="close-btn" id="closeAiSummaryBtn">&times;</button>
      </div>
      <div class="modal-body" id="aiSummaryBody">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="attachmentModal">
    <div class="modal-content attachment-modal-content">
      <div class="modal-header">
        <h2 id="attachmentModalTitle">Attachment</h2>
        <button class="close-btn" id="closeAttachmentBtn">&times;</button>
      </div>
      <div class="modal-body attachment-modal-body" id="attachmentModalBody">
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary" id="downloadAttachmentBtn" download>Download</a>
      </div>
    </div>
  </div>

  <script src="toast.js"></script>
  <script>
    const API_BASE = '';
    let allFeedback = [];
    let analytics = null;

    const sourceIcons = {
      support_ticket: 'üé´',
      discord: 'üí¨',
      github: 'üêô',
      twitter: 'üê¶',
      email: 'üìß'
    };

    async function fetchAnalytics() {
      try {
        const response = await fetch(`${API_BASE}/api/analytics`);
        if (!response.ok) throw new Error('Failed to fetch analytics');
        analytics = await response.json();
        updateAnalytics();
      } catch (error) {
        console.error('Error fetching analytics:', error);
        showError('Failed to load analytics data');
        toast.error('Failed to load analytics data');
      }
    }

    async function fetchFeedback() {
      showLoading(true);
      try {
        const response = await fetch(`${API_BASE}/api/feedback?limit=100`);
        if (!response.ok) throw new Error('Failed to fetch feedback');
        allFeedback = await response.json();
        renderFeedbackTable();
        showLoading(false);
        toast.success(`Loaded ${allFeedback.length} feedback items`, 2000);
      } catch (error) {
        console.error('Error fetching feedback:', error);
        showError('Failed to load feedback data');
        toast.error('Failed to load feedback data');
        showLoading(false);
      }
    }

    // Animate number counting
    function animateNumber(element, target, duration = 1000) {
      const start = parseInt(element.textContent) || 0;
      const increment = (target - start) / (duration / 16);
      let current = start;
      
      const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
          element.textContent = target;
          clearInterval(timer);
        } else {
          element.textContent = Math.round(current);
        }
      }, 16);
    }

    function updateAnalytics() {
      if (!analytics) return;

      animateNumber(document.getElementById('totalFeedback'), analytics.totalFeedback);

      // Update top themes display
      const topThemesEl = document.getElementById('topThemesDisplay');
      if (analytics.topThemes && analytics.topThemes.length > 0) {
        topThemesEl.textContent = analytics.topThemes.slice(0, 3).map(t => t.theme).join(', ');
      } else {
        topThemesEl.textContent = '-';
      }
    }

    function renderFeedbackTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sourceFilter = document.getElementById('sourceFilter').value;
      const sentimentFilter = document.getElementById('sentimentFilter').value;
      const urgencyFilter = document.getElementById('urgencyFilter').value;
      const tbody = document.getElementById('feedbackTableBody');

      let filtered = allFeedback.filter(item => {
        if (searchTerm && !item.content.toLowerCase().includes(searchTerm)) return false;
        if (sourceFilter && item.source !== sourceFilter) return false;
        if (sentimentFilter && item.sentiment !== sentimentFilter) return false;
        if (urgencyFilter && item.urgency !== urgencyFilter) return false;
        return true;
      });

      // Sort: critical items first, then by date
      filtered.sort((a, b) => {
        if (a.urgency === 'critical' && b.urgency !== 'critical') return -1;
        if (a.urgency !== 'critical' && b.urgency === 'critical') return 1;
        return new Date(b.created_at) - new Date(a.created_at);
      });

      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #718096;">No feedback found</td></tr>';
        return;
      }

      filtered.forEach(item => {
        const tr = document.createElement('tr');
        tr.onclick = () => showFeedbackDetail(item);

        const preview = item.content.length > 80 ? item.content.substring(0, 80) + '...' : item.content;
        const sourceClass = item.source.replace('_', '-');
        const themesHtml = item.themes ? item.themes.map(t => `<span class="theme-tag">${t}</span>`).join('') : '';
        const relativeTime = getRelativeTime(item.created_at);
        
        // Attachment icon
        const attachmentHtml = item.attachment_url 
          ? `<span class="attachment-icon" onclick="event.stopPropagation(); viewAttachment('${item.attachment_url}', ${item.id})" title="View attachment">üìé</span>`
          : '-';

        tr.innerHTML = `
          <td><span class="badge badge-${sourceClass}">${sourceIcons[item.source] || 'üìù'} ${item.source.replace('_', ' ')}</span></td>
          <td>${preview}</td>
          <td>${item.sentiment ? `<span class="badge badge-${item.sentiment}">${item.sentiment}</span>` : '-'}</td>
          <td>${item.urgency ? `<span class="badge badge-${item.urgency}">${item.urgency}</span>` : '-'}</td>
          <td>${themesHtml || '-'}</td>
          <td>${attachmentHtml}</td>
          <td>${relativeTime}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    function getRelativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      return date.toLocaleDateString();
    }

    function showFeedbackDetail(item) {
      const modal = document.getElementById('feedbackModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = 'Feedback Details';
      
      const themesHtml = item.themes && item.themes.length > 0 
        ? item.themes.map(t => `<span class="theme-tag">${t}</span>`).join(' ') 
        : '<span style="color: #9ca3af;">Not analyzed yet</span>';
      
      const sentimentDisplay = item.sentiment 
        ? `<span class="badge badge-${item.sentiment}">${item.sentiment.toUpperCase()}</span> <span style="color: #6b7280; font-size: 0.875rem;">(Score: ${(item.sentiment_score || 0).toFixed(2)})</span>`
        : '<span style="color: #9ca3af;">Not analyzed yet</span>';
      
      const urgencyDisplay = item.urgency
        ? `<span class="badge badge-${item.urgency}">${item.urgency.toUpperCase()}</span>`
        : '<span style="color: #9ca3af;">Not analyzed yet</span>';
      
      modalBody.innerHTML = `
        <div style="display: grid; gap: 1.5rem;">
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Source</div>
            <span class="badge badge-${item.source.replace('_', '-')}">${sourceIcons[item.source] || 'üìù'} ${item.source.replace('_', ' ').toUpperCase()}</span>
          </div>
          
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Author</div>
            <div style="font-size: 1rem; color: #111827;">${item.author || 'Unknown'}</div>
          </div>
          
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Date</div>
            <div style="font-size: 0.875rem; color: #111827;">${new Date(item.created_at).toLocaleString()}</div>
          </div>
          
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Feedback Content</div>
            <div style="padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; line-height: 1.6; color: #111827;">${item.content}</div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Sentiment</div>
              <div>${sentimentDisplay}</div>
            </div>
            
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Urgency</div>
              <div>${urgencyDisplay}</div>
            </div>
            
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Themes</div>
              <div>${themesHtml}</div>
            </div>
          </div>
          
          ${!item.sentiment || !item.urgency ? `
            <div style="padding: 1rem; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; font-size: 0.875rem; color: #92400e;">
              ‚ö†Ô∏è This feedback hasn't been analyzed yet. Click the "ü§ñ Analyze Feedback" button to process it.
            </div>
          ` : ''}
        </div>
      `;

      modal.classList.add('active');
    }

    function showAddFeedbackForm() {
      const modal = document.getElementById('feedbackModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = 'Add New Feedback';
      
      modalBody.innerHTML = `
        <form id="addFeedbackForm">
          <div class="form-group">
            <label for="feedbackSource">Source *</label>
            <select id="feedbackSource" required>
              <option value="">Select source...</option>
              <option value="support_ticket">Support Ticket</option>
              <option value="discord">Discord</option>
              <option value="github">GitHub</option>
              <option value="twitter">Twitter</option>
              <option value="email">Email</option>
            </select>
          </div>
          <div class="form-group">
            <label for="feedbackContent">Content *</label>
            <textarea id="feedbackContent" required placeholder="Enter feedback content..."></textarea>
          </div>
          <div class="form-group">
            <label for="feedbackAuthor">Author *</label>
            <input type="text" id="feedbackAuthor" required placeholder="e.g., user_123">
          </div>
          <button type="submit" class="btn btn-primary">Submit Feedback</button>
        </form>
      `;

      modal.classList.add('active');

      document.getElementById('addFeedbackForm').onsubmit = async (e) => {
        e.preventDefault();
        await submitFeedback();
      };
    }

    async function submitFeedback() {
      const source = document.getElementById('feedbackSource').value;
      const content = document.getElementById('feedbackContent').value;
      const author = document.getElementById('feedbackAuthor').value;

      try {
        const response = await fetch(`${API_BASE}/api/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, content, author })
        });

        if (!response.ok) throw new Error('Failed to submit feedback');

        closeModal();
        
        await fetch(`${API_BASE}/api/analyze`, { method: 'POST' });
        
        await refreshData();
        
      } catch (error) {
        console.error('Error submitting feedback:', error);
        showError('Failed to submit feedback');
      }
    }

    function closeModal() {
      document.getElementById('feedbackModal').classList.remove('active');
    }

    function showLoading(show) {
      document.getElementById('loadingSpinner').classList.toggle('active', show);
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('active');
      setTimeout(() => errorEl.classList.remove('active'), 5000);
    }

    async function analyzeFeedback() {
      const analyzeBtn = document.getElementById('analyzeBtn');
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = '‚è≥ Analyzing...';
      
      try {
        const response = await fetch(`${API_BASE}/api/analyze`, {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to analyze feedback');
        
        const result = await response.json();
        alert(`Successfully analyzed ${result.analyzed} feedback items!`);
        
        await refreshData();
      } catch (error) {
        console.error('Error analyzing feedback:', error);
        showError('Failed to analyze feedback');
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'ü§ñ Analyze Feedback';
      }
    }

    async function refreshData() {
      await Promise.all([fetchAnalytics(), fetchFeedback()]);
    }

    function showAddFeedbackForm() {
      const modal = document.getElementById('feedbackModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = 'Add New Feedback';
      
      modalBody.innerHTML = `
        <form id="addFeedbackForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
          <div class="form-group">
            <label for="feedbackSource" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Source *</label>
            <select id="feedbackSource" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; font-family: inherit;">
              <option value="">Select source...</option>
              <option value="support_ticket">üé´ Support Ticket</option>
              <option value="discord">üí¨ Discord</option>
              <option value="github">üêô GitHub</option>
              <option value="twitter">üê¶ Twitter</option>
              <option value="email">üìß Email</option>
            </select>
          </div>
          <div class="form-group">
            <label for="feedbackContent" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Feedback Content *</label>
            <textarea id="feedbackContent" required placeholder="Enter feedback content..." style="width: 100%; min-height: 120px; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; font-family: inherit; resize: vertical;"></textarea>
          </div>
          <div class="form-group">
            <label for="feedbackAuthor" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Author *</label>
            <input type="text" id="feedbackAuthor" required placeholder="e.g., user_123 or email@example.com" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; font-family: inherit;">
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Feedback</button>
        </form>
      `;

      modal.classList.add('active');

      document.getElementById('addFeedbackForm').onsubmit = async (e) => {
        e.preventDefault();
        await submitFeedback();
      };
    }

    async function submitFeedback() {
      const source = document.getElementById('feedbackSource').value;
      const content = document.getElementById('feedbackContent').value;
      const author = document.getElementById('feedbackAuthor').value;

      const submitBtn = document.querySelector('#addFeedbackForm button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const response = await fetch(`${API_BASE}/api/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, content, author })
        });

        if (!response.ok) throw new Error('Failed to submit feedback');

        closeModal();
        await refreshData();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 2rem; right: 2rem; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; animation: fadeIn 0.3s ease-out;';
        successMsg.textContent = '‚úÖ Feedback submitted successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      } catch (error) {
        console.error('Error submitting feedback:', error);
        alert('Failed to submit feedback. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Feedback';
      }
    }

    async function showAISummary() {
      const modal = document.getElementById('aiSummaryModal');
      const modalBody = document.getElementById('aiSummaryBody');
      
      modal.classList.add('active');
      modalBody.innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 1rem;">Generating AI summary...</p>';

      try {
        // Get current filters
        const filters = {
          source: document.getElementById('sourceFilter').value || null,
          sentiment: document.getElementById('sentimentFilter').value || null,
          urgency: document.getElementById('urgencyFilter').value || null
        };

        const response = await fetch(`${API_BASE}/api/ai-summarize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filters })
        });

        if (!response.ok) throw new Error('Failed to generate AI summary');

        const data = await response.json();

        // Format the summary nicely
        modalBody.innerHTML = `
          <div class="ai-summary-container">
            <div class="summary-stats">
              <div class="stat-item">
                <span class="stat-label">Total Analyzed</span>
                <span class="stat-value">${data.stats.totalItems}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Positive</span>
                <span class="stat-value" style="color: #10b981;">${data.stats.sentimentBreakdown.positive}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Neutral</span>
                <span class="stat-value" style="color: #6b7280;">${data.stats.sentimentBreakdown.neutral}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Negative</span>
                <span class="stat-value" style="color: #ef4444;">${data.stats.sentimentBreakdown.negative}</span>
              </div>
            </div>
            
            <div class="ai-summary-content">
              <h3>üìä AI-Generated Insights</h3>
              <div class="summary-text">${data.summary.replace(/\n/g, '<br>')}</div>
            </div>

            <div class="summary-footer">
              <small>Generated using Cloudflare Workers AI (Llama 3) ‚Ä¢ ${new Date().toLocaleString()}</small>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error generating AI summary:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <p style="color: #ef4444; font-size: 1.125rem; margin-bottom: 1rem;">‚ùå Failed to generate AI summary</p>
            <p style="color: #6b7280;">${error.message}</p>
            <button class="btn btn-primary" onclick="document.getElementById('aiSummaryModal').classList.remove('active')" style="margin-top: 1rem;">Close</button>
          </div>
        `;
      }
    }

    function closeAiSummaryModal() {
      document.getElementById('aiSummaryModal').classList.remove('active');
    }

    async function runAiAnalysis() {
      const btn = document.getElementById('runAiAnalysisBtn');
      const icon = document.getElementById('aiAnalysisIcon');
      const statusText = document.getElementById('statusText');
      
      // Show loading state
      btn.disabled = true;
      btn.classList.add('loading');
      icon.textContent = '‚è≥';
      statusText.textContent = 'AI analysis in progress...';
      statusText.style.color = '#667eea';

      try {
        const response = await fetch(`${API_BASE}/api/workflow/trigger`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) throw new Error('Failed to start workflow');

        const data = await response.json();
        console.log('Workflow started:', data);

        // Show success message
        statusText.textContent = 'AI analysis started! Refreshing data...';
        statusText.style.color = '#10b981';

        // Wait 5 seconds then refresh data
        setTimeout(async () => {
          await refreshData();
          
          // Update status
          updateAnalysisStatus();
          
          // Reset button
          btn.disabled = false;
          btn.classList.remove('loading');
          icon.textContent = 'ü§ñ';
          
          // Show success toast
          const successMsg = document.createElement('div');
          successMsg.style.cssText = 'position: fixed; top: 2rem; right: 2rem; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; animation: fadeIn 0.3s ease-out;';
          successMsg.textContent = '‚úÖ AI analysis completed successfully!';
          document.body.appendChild(successMsg);
          setTimeout(() => successMsg.remove(), 3000);
        }, 5000);

      } catch (error) {
        console.error('Error running AI analysis:', error);
        
        // Show error state
        statusText.textContent = 'Analysis failed';
        statusText.style.color = '#ef4444';
        
        // Reset button
        btn.disabled = false;
        btn.classList.remove('loading');
        icon.textContent = 'ü§ñ';
        
        alert('Failed to start AI analysis. Please try again.');
      }
    }

    function updateAnalysisStatus() {
      const statusText = document.getElementById('statusText');
      
      // Count unprocessed feedback
      const unprocessed = allFeedback.filter(f => !f.processed || f.processed === 0).length;
      
      if (unprocessed > 0) {
        statusText.textContent = `${unprocessed} items pending analysis`;
        statusText.style.color = '#f59e0b';
      } else {
        // Find most recent processed feedback
        const processedItems = allFeedback.filter(f => f.processed === 1);
        if (processedItems.length > 0) {
          statusText.textContent = 'All feedback analyzed';
          statusText.style.color = '#10b981';
        } else {
          statusText.textContent = 'Ready';
          statusText.style.color = '#6b7280';
        }
      }
    }

    // AI Search functionality
    async function performAISearch() {
      const query = document.getElementById('aiSearchInput').value.trim();
      if (!query) {
        alert('Please enter a search query');
        return;
      }

      const searchBtn = document.getElementById('aiSearchBtn');
      const resultsContainer = document.getElementById('searchResultsContainer');
      const resultsContent = document.getElementById('searchResultsContent');
      const resultsTitle = document.getElementById('searchResultsTitle');

      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';
      resultsContent.innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 1rem;">Searching for similar feedback...</p>';
      resultsContainer.style.display = 'block';

      try {
        const response = await fetch(`${API_BASE}/api/search/similar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, limit: 10 })
        });

        if (!response.ok) throw new Error('Search failed');

        const data = await response.json();
        resultsTitle.textContent = `Search Results for "${query}" (${data.count} found)`;

        if (data.results.length === 0) {
          resultsContent.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No similar feedback found. Try a different search term.</p>';
        } else {
          resultsContent.innerHTML = data.results.map(item => {
            const similarity = (item.similarity * 100).toFixed(0);
            const similarityClass = similarity >= 80 ? 'high' : similarity >= 50 ? 'medium' : 'low';
            const themesHtml = item.themes && Array.isArray(item.themes) ? item.themes.map(t => `<span class="theme-tag">${t}</span>`).join('') : '';
            
            return `
              <div class="search-result-card" onclick="showFeedbackDetail(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                <div class="similarity-score similarity-${similarityClass}">
                  <div class="similarity-bar" style="width: ${similarity}%"></div>
                  <span class="similarity-text">${similarity}% match</span>
                </div>
                <div class="search-result-content">
                  <p>${item.content}</p>
                </div>
                <div class="search-result-meta">
                  <span class="badge badge-${item.source?.replace('_', '-')}">${sourceIcons[item.source] || 'üìù'} ${item.source?.replace('_', ' ')}</span>
                  ${item.sentiment ? `<span class="badge badge-${item.sentiment}">${item.sentiment}</span>` : ''}
                  ${themesHtml}
                  <span style="color: #9ca3af; font-size: 0.75rem;">${new Date(item.created_at).toLocaleDateString()}</span>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('AI search error:', error);
        resultsContent.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 2rem;">‚ùå Search failed. Please try again.</p>';
        toast.error('Search failed. Please try again.');
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Search';
      }
    }

    function clearAISearch() {
      document.getElementById('aiSearchInput').value = '';
      document.getElementById('searchResultsContainer').style.display = 'none';
    }

    // View attachment in modal
    function viewAttachment(url, feedbackId) {
      const modal = document.getElementById('attachmentModal');
      const modalBody = document.getElementById('attachmentModalBody');
      const downloadBtn = document.getElementById('downloadAttachmentBtn');
      
      const fileUrl = `/api/feedback/file/${encodeURIComponent(url)}`;
      downloadBtn.href = fileUrl;
      
      // Determine file type
      const ext = url.split('.').pop().toLowerCase();
      const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
      
      if (isImage) {
        modalBody.innerHTML = `<img src="${fileUrl}" alt="Attachment" style="max-width: 100%; height: auto; border-radius: 8px;">`;
      } else {
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 3rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üìÑ</div>
            <p style="color: #6b7280; margin-bottom: 1rem;">Preview not available for this file type</p>
            <p style="font-size: 0.875rem; color: #9ca3af;">${url}</p>
          </div>
        `;
      }
      
      modal.classList.add('active');
    }

    function closeAttachmentModal() {
      document.getElementById('attachmentModal').classList.remove('active');
    }

    // Index all feedback for semantic search
    async function indexAllEmbeddings() {
      const btn = document.getElementById('indexEmbeddingsBtn');
      const icon = document.getElementById('indexIcon');
      
      btn.disabled = true;
      icon.style.animation = 'spin 1s linear infinite';
      btn.querySelector('.btn-text').textContent = 'Indexing...';

      try {
        const response = await fetch(`${API_BASE}/api/embeddings/index-all`, {
          method: 'POST'
        });

        if (!response.ok) throw new Error('Indexing failed');

        const data = await response.json();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 2rem; right: 2rem; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;';
        successMsg.textContent = `‚úì All feedback indexed for AI search (${data.indexed} items)`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 4000);

      } catch (error) {
        console.error('Indexing error:', error);
        alert('Failed to index feedback. Please try again.');
      } finally {
        btn.disabled = false;
        icon.style.animation = '';
        btn.querySelector('.btn-text').textContent = 'Index All Feedback';
      }
    }

    // Set up event handlers for existing elements only
    const aiSearchBtn = document.getElementById('aiSearchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const closeAttachmentBtn = document.getElementById('closeAttachmentBtn');
    const addFeedbackFab = document.getElementById('addFeedbackFab');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeAiSummaryBtn = document.getElementById('closeAiSummaryBtn');
    
    if (aiSearchBtn) aiSearchBtn.onclick = performAISearch;
    if (clearSearchBtn) clearSearchBtn.onclick = clearAISearch;
    if (closeAttachmentBtn) closeAttachmentBtn.onclick = closeAttachmentModal;
    if (addFeedbackFab) addFeedbackFab.onclick = showAddFeedbackForm;
    if (closeModalBtn) closeModalBtn.onclick = closeModal;
    if (closeAiSummaryBtn) closeAiSummaryBtn.onclick = closeAiSummaryModal;
    
    const attachmentModal = document.getElementById('attachmentModal');
    const feedbackModal = document.getElementById('feedbackModal');
    const aiSummaryModal = document.getElementById('aiSummaryModal');
    
    if (attachmentModal) {
      attachmentModal.onclick = (e) => {
        if (e.target.id === 'attachmentModal') closeAttachmentModal();
      };
    }
    if (feedbackModal) {
      feedbackModal.onclick = (e) => {
        if (e.target.id === 'feedbackModal') closeModal();
      };
    }
    if (aiSummaryModal) {
      aiSummaryModal.onclick = (e) => {
        if (e.target.id === 'aiSummaryModal') closeAiSummaryModal();
      };
    }

    const searchInput = document.getElementById('searchInput');
    const sourceFilter = document.getElementById('sourceFilter');
    const sentimentFilter = document.getElementById('sentimentFilter');
    const urgencyFilter = document.getElementById('urgencyFilter');
    
    if (searchInput) searchInput.oninput = renderFeedbackTable;
    if (sourceFilter) sourceFilter.onchange = renderFeedbackTable;
    if (sentimentFilter) sentimentFilter.onchange = renderFeedbackTable;
    if (urgencyFilter) urgencyFilter.onchange = renderFeedbackTable;

    async function fetchWorkflowStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/workflow/status`);
        if (!response.ok) return;
        
        const status = await response.json();
        updateWorkflowStatus(status);
      } catch (error) {
        console.error('Error fetching workflow status:', error);
      }
    }

    function updateWorkflowStatus(status) {
      const statusText = document.getElementById('statusText');
      const statusBadge = document.getElementById('statusBadge');
      const btn = document.getElementById('runAiAnalysisBtn');
      
      // Update badge
      if (status.unprocessed > 0) {
        statusBadge.textContent = status.unprocessed;
        statusBadge.style.display = 'inline-block';
      } else {
        statusBadge.style.display = 'none';
      }
      
      // Update status text and button state
      if (status.unprocessed > 0) {
        statusText.textContent = `${status.unprocessed} items pending analysis`;
        statusText.style.color = '#f59e0b';
        btn.disabled = false;
      } else {
        statusText.textContent = 'All feedback analyzed';
        statusText.style.color = '#10b981';
        btn.disabled = true;
      }
      
      // Show recently processed info if available
      if (status.recentlyProcessed > 0 && status.unprocessed === 0) {
        statusText.textContent = `All analyzed (${status.recentlyProcessed} in last hour)`;
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initializing...');
      refreshData();
      setInterval(refreshData, 30000);
      
      // Poll workflow status every 10 seconds
      fetchWorkflowStatus();
      setInterval(fetchWorkflowStatus, 10000);
      
      // Update status on initial load and after each refresh
      setTimeout(updateAnalysisStatus, 1000);
    });

    // Also try to load immediately in case DOM is already loaded
    if (document.readyState === 'loading') {
      // DOM is still loading, event listener will handle it
    } else {
      // DOM is already loaded
      console.log('Dashboard initializing (DOM already ready)...');
      refreshData();
      setInterval(refreshData, 30000);
      fetchWorkflowStatus();
      setInterval(fetchWorkflowStatus, 10000);
      setTimeout(updateAnalysisStatus, 1000);
    }
  </script>
</body>
</html>
