<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback Intelligence Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="critical.css">
</head>
<body>
  <div class="header">
    <h1>üìä Feedback Intelligence Dashboard</h1>
  </div>

  <div class="welcome-guide" id="welcomeGuide">
    <div class="guide-content">
      <h2>üëã Welcome to Your Feedback Dashboard</h2>
      <p>This dashboard helps you manage and analyze customer feedback from multiple sources.</p>
      <div class="guide-steps">
        <div class="guide-step">
          <span class="step-number">1</span>
          <div class="step-content">
            <strong>View Feedback</strong>
            <p>All feedback is displayed in the table below. Click any row to see full details.</p>
          </div>
        </div>
        <div class="guide-step">
          <span class="step-number">2</span>
          <div class="step-content">
            <strong>Filter & Search</strong>
            <p>Use the filters to find specific feedback by source, sentiment, or urgency.</p>
          </div>
        </div>
        <div class="guide-step">
          <span class="step-number">3</span>
          <div class="step-content">
            <strong>Analyze</strong>
            <p>Click "Analyze Feedback" to automatically categorize sentiment, urgency, and themes.</p>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="document.getElementById('welcomeGuide').style.display='none'">Got it! Show me the dashboard</button>
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-label">Total Feedback</div>
      <div class="metric-value" id="totalFeedback">0</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Top Themes</div>
      <div id="topThemesDisplay" style="font-size: 0.875rem; color: #667eea; font-weight: 600;">-</div>
    </div>
  </div>

  <div class="dashboard-container">
    <main class="main-content" style="padding-left: 0;">
      <div class="card">
        <h3>üí¨ Feedback Items</h3>
        <div class="filters">
          <input type="text" class="search-input" id="searchInput" placeholder="üîç Search feedback...">
          <select class="filter-select" id="sourceFilter">
            <option value="">All Sources</option>
            <option value="support_ticket">Support Ticket</option>
            <option value="discord">Discord</option>
            <option value="github">GitHub</option>
            <option value="twitter">Twitter</option>
            <option value="email">Email</option>
          </select>
          <select class="filter-select" id="sentimentFilter">
            <option value="">All Sentiments</option>
            <option value="positive">Positive</option>
            <option value="neutral">Neutral</option>
            <option value="negative">Negative</option>
          </select>
          <select class="filter-select" id="urgencyFilter">
            <option value="">All Urgency</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
          <button class="btn btn-primary" id="analyzeBtn">ü§ñ Analyze Feedback</button>
        </div>

        <div class="spinner" id="loadingSpinner"></div>
        <div class="error-message" id="errorMessage"></div>

        <table class="feedback-table" id="feedbackTable">
          <thead>
            <tr>
              <th>Source</th>
              <th>Content</th>
              <th>Sentiment</th>
              <th>Urgency</th>
              <th>Themes</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="feedbackTableBody">
          </tbody>
        </table>
        <div class="table-hint">üí° Hover over any row to view details</div>
      </div>
    </main>
  </div>

  <div class="modal" id="feedbackModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Feedback Details</h2>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
      </div>
    </div>
  </div>

  <button class="fab" id="addFeedbackFab" title="Add New Feedback">
    ‚ûï
  </button>

  <script>
    const API_BASE = '';
    let allFeedback = [];
    let analytics = null;

    const sourceIcons = {
      support_ticket: 'üé´',
      discord: 'üí¨',
      github: 'üêô',
      twitter: 'üê¶',
      email: 'üìß'
    };

    async function fetchAnalytics() {
      try {
        const response = await fetch(`${API_BASE}/api/analytics`);
        if (!response.ok) throw new Error('Failed to fetch analytics');
        analytics = await response.json();
        updateAnalytics();
      } catch (error) {
        console.error('Error fetching analytics:', error);
        showError('Failed to load analytics data');
      }
    }

    async function fetchFeedback() {
      showLoading(true);
      try {
        const response = await fetch(`${API_BASE}/api/feedback?limit=100`);
        if (!response.ok) throw new Error('Failed to fetch feedback');
        allFeedback = await response.json();
        renderFeedbackTable();
        showLoading(false);
      } catch (error) {
        console.error('Error fetching feedback:', error);
        showError('Failed to load feedback data');
        showLoading(false);
      }
    }

    // Animate number counting
    function animateNumber(element, target, duration = 1000) {
      const start = parseInt(element.textContent) || 0;
      const increment = (target - start) / (duration / 16);
      let current = start;
      
      const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
          element.textContent = target;
          clearInterval(timer);
        } else {
          element.textContent = Math.round(current);
        }
      }, 16);
    }

    function updateAnalytics() {
      if (!analytics) return;

      animateNumber(document.getElementById('totalFeedback'), analytics.totalFeedback);

      // Update top themes display
      const topThemesEl = document.getElementById('topThemesDisplay');
      if (analytics.topThemes && analytics.topThemes.length > 0) {
        topThemesEl.textContent = analytics.topThemes.slice(0, 3).map(t => t.theme).join(', ');
      } else {
        topThemesEl.textContent = '-';
      }
    }

    function renderFeedbackTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sourceFilter = document.getElementById('sourceFilter').value;
      const sentimentFilter = document.getElementById('sentimentFilter').value;
      const urgencyFilter = document.getElementById('urgencyFilter').value;
      const tbody = document.getElementById('feedbackTableBody');

      let filtered = allFeedback.filter(item => {
        if (searchTerm && !item.content.toLowerCase().includes(searchTerm)) return false;
        if (sourceFilter && item.source !== sourceFilter) return false;
        if (sentimentFilter && item.sentiment !== sentimentFilter) return false;
        if (urgencyFilter && item.urgency !== urgencyFilter) return false;
        return true;
      });

      // Sort: critical items first, then by date
      filtered.sort((a, b) => {
        if (a.urgency === 'critical' && b.urgency !== 'critical') return -1;
        if (a.urgency !== 'critical' && b.urgency === 'critical') return 1;
        return new Date(b.created_at) - new Date(a.created_at);
      });

      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #718096;">No feedback found</td></tr>';
        return;
      }

      filtered.forEach(item => {
        const tr = document.createElement('tr');
        tr.onclick = () => showFeedbackDetail(item);

        const preview = item.content.length > 80 ? item.content.substring(0, 80) + '...' : item.content;
        const sourceClass = item.source.replace('_', '-');
        const themesHtml = item.themes ? item.themes.map(t => `<span class="theme-tag">${t}</span>`).join('') : '';
        const relativeTime = getRelativeTime(item.created_at);

        tr.innerHTML = `
          <td><span class="badge badge-${sourceClass}">${sourceIcons[item.source] || 'üìù'} ${item.source.replace('_', ' ')}</span></td>
          <td>${preview}</td>
          <td>${item.sentiment ? `<span class="badge badge-${item.sentiment}">${item.sentiment}</span>` : '-'}</td>
          <td>${item.urgency ? `<span class="badge badge-${item.urgency}">${item.urgency}</span>` : '-'}</td>
          <td>${themesHtml || '-'}</td>
          <td>${relativeTime}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    function getRelativeTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      return date.toLocaleDateString();
    }

    function showFeedbackDetail(item) {
      const modal = document.getElementById('feedbackModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = 'Feedback Details';
      
      const themesHtml = item.themes && item.themes.length > 0 
        ? item.themes.map(t => `<span class="theme-tag">${t}</span>`).join(' ') 
        : '<span style="color: #9ca3af;">Not analyzed yet</span>';
      
      const sentimentDisplay = item.sentiment 
        ? `<span class="badge badge-${item.sentiment}">${item.sentiment.toUpperCase()}</span> <span style="color: #6b7280; font-size: 0.875rem;">(Score: ${(item.sentiment_score || 0).toFixed(2)})</span>`
        : '<span style="color: #9ca3af;">Not analyzed yet</span>';
      
      const urgencyDisplay = item.urgency
        ? `<span class="badge badge-${item.urgency}">${item.urgency.toUpperCase()}</span>`
        : '<span style="color: #9ca3af;">Not analyzed yet</span>';
      
      modalBody.innerHTML = `
        <div style="display: grid; gap: 1.5rem;">
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Source</div>
            <span class="badge badge-${item.source.replace('_', '-')}">${sourceIcons[item.source] || 'üìù'} ${item.source.replace('_', ' ').toUpperCase()}</span>
          </div>
          
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Author</div>
            <div style="font-size: 1rem; color: #111827;">${item.author || 'Unknown'}</div>
          </div>
          
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Date</div>
            <div style="font-size: 0.875rem; color: #111827;">${new Date(item.created_at).toLocaleString()}</div>
          </div>
          
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Feedback Content</div>
            <div style="padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; line-height: 1.6; color: #111827;">${item.content}</div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Sentiment</div>
              <div>${sentimentDisplay}</div>
            </div>
            
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Urgency</div>
              <div>${urgencyDisplay}</div>
            </div>
            
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; margin-bottom: 0.5rem;">Themes</div>
              <div>${themesHtml}</div>
            </div>
          </div>
          
          ${!item.sentiment || !item.urgency ? `
            <div style="padding: 1rem; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; font-size: 0.875rem; color: #92400e;">
              ‚ö†Ô∏è This feedback hasn't been analyzed yet. Click the "ü§ñ Analyze Feedback" button to process it.
            </div>
          ` : ''}
        </div>
      `;

      modal.classList.add('active');
    }

    function showAddFeedbackForm() {
      const modal = document.getElementById('feedbackModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = 'Add New Feedback';
      
      modalBody.innerHTML = `
        <form id="addFeedbackForm">
          <div class="form-group">
            <label for="feedbackSource">Source *</label>
            <select id="feedbackSource" required>
              <option value="">Select source...</option>
              <option value="support_ticket">Support Ticket</option>
              <option value="discord">Discord</option>
              <option value="github">GitHub</option>
              <option value="twitter">Twitter</option>
              <option value="email">Email</option>
            </select>
          </div>
          <div class="form-group">
            <label for="feedbackContent">Content *</label>
            <textarea id="feedbackContent" required placeholder="Enter feedback content..."></textarea>
          </div>
          <div class="form-group">
            <label for="feedbackAuthor">Author *</label>
            <input type="text" id="feedbackAuthor" required placeholder="e.g., user_123">
          </div>
          <button type="submit" class="btn btn-primary">Submit Feedback</button>
        </form>
      `;

      modal.classList.add('active');

      document.getElementById('addFeedbackForm').onsubmit = async (e) => {
        e.preventDefault();
        await submitFeedback();
      };
    }

    async function submitFeedback() {
      const source = document.getElementById('feedbackSource').value;
      const content = document.getElementById('feedbackContent').value;
      const author = document.getElementById('feedbackAuthor').value;

      try {
        const response = await fetch(`${API_BASE}/api/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, content, author })
        });

        if (!response.ok) throw new Error('Failed to submit feedback');

        closeModal();
        
        await fetch(`${API_BASE}/api/analyze`, { method: 'POST' });
        
        await refreshData();
        
      } catch (error) {
        console.error('Error submitting feedback:', error);
        showError('Failed to submit feedback');
      }
    }

    function closeModal() {
      document.getElementById('feedbackModal').classList.remove('active');
    }

    function showLoading(show) {
      document.getElementById('loadingSpinner').classList.toggle('active', show);
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('active');
      setTimeout(() => errorEl.classList.remove('active'), 5000);
    }

    async function analyzeFeedback() {
      const analyzeBtn = document.getElementById('analyzeBtn');
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = '‚è≥ Analyzing...';
      
      try {
        const response = await fetch(`${API_BASE}/api/analyze`, {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to analyze feedback');
        
        const result = await response.json();
        alert(`Successfully analyzed ${result.analyzed} feedback items!`);
        
        await refreshData();
      } catch (error) {
        console.error('Error analyzing feedback:', error);
        showError('Failed to analyze feedback');
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'ü§ñ Analyze Feedback';
      }
    }

    async function refreshData() {
      await Promise.all([fetchAnalytics(), fetchFeedback()]);
    }

    function showAddFeedbackForm() {
      const modal = document.getElementById('feedbackModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      modalTitle.textContent = 'Add New Feedback';
      
      modalBody.innerHTML = `
        <form id="addFeedbackForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
          <div class="form-group">
            <label for="feedbackSource" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Source *</label>
            <select id="feedbackSource" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; font-family: inherit;">
              <option value="">Select source...</option>
              <option value="support_ticket">üé´ Support Ticket</option>
              <option value="discord">üí¨ Discord</option>
              <option value="github">üêô GitHub</option>
              <option value="twitter">üê¶ Twitter</option>
              <option value="email">üìß Email</option>
            </select>
          </div>
          <div class="form-group">
            <label for="feedbackContent" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Feedback Content *</label>
            <textarea id="feedbackContent" required placeholder="Enter feedback content..." style="width: 100%; min-height: 120px; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; font-family: inherit; resize: vertical;"></textarea>
          </div>
          <div class="form-group">
            <label for="feedbackAuthor" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Author *</label>
            <input type="text" id="feedbackAuthor" required placeholder="e.g., user_123 or email@example.com" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.875rem; font-family: inherit;">
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Feedback</button>
        </form>
      `;

      modal.classList.add('active');

      document.getElementById('addFeedbackForm').onsubmit = async (e) => {
        e.preventDefault();
        await submitFeedback();
      };
    }

    async function submitFeedback() {
      const source = document.getElementById('feedbackSource').value;
      const content = document.getElementById('feedbackContent').value;
      const author = document.getElementById('feedbackAuthor').value;

      const submitBtn = document.querySelector('#addFeedbackForm button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const response = await fetch(`${API_BASE}/api/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, content, author })
        });

        if (!response.ok) throw new Error('Failed to submit feedback');

        closeModal();
        await refreshData();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 2rem; right: 2rem; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; animation: fadeIn 0.3s ease-out;';
        successMsg.textContent = '‚úÖ Feedback submitted successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      } catch (error) {
        console.error('Error submitting feedback:', error);
        alert('Failed to submit feedback. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Feedback';
      }
    }

    document.getElementById('analyzeBtn').onclick = analyzeFeedback;
    document.getElementById('addFeedbackFab').onclick = showAddFeedbackForm;
    document.getElementById('closeModalBtn').onclick = closeModal;
    document.getElementById('feedbackModal').onclick = (e) => {
      if (e.target.id === 'feedbackModal') closeModal();
    };

    document.getElementById('searchInput').oninput = renderFeedbackTable;
    document.getElementById('sourceFilter').onchange = renderFeedbackTable;
    document.getElementById('sentimentFilter').onchange = renderFeedbackTable;
    document.getElementById('urgencyFilter').onchange = renderFeedbackTable;

    refreshData();
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
